<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Map - GeoShare</title>

    <link rel="stylesheet" href="theme.css" type="text/css"/>

    <link rel="stylesheet" href="geomaps-styles/main.css" type="text/css"/>
    <link rel="stylesheet" href="geomaps-styles/navbar.css" type="text/css"/>
    <link rel="stylesheet" href="geomaps-styles/map.css" type="text/css"/>
    <link rel="stylesheet" href="geomaps-styles/friendsbar.css" type="text/css"/>
    <link rel="stylesheet" href="geomaps-styles/search.css" type="text/css"/>
    <link rel="stylesheet" href="geomaps-styles/friend-search.css" type="text/css"/>
    <link rel="stylesheet" href="geomaps-styles/settings.css" type="text/css"/>

    <script src="https://apis.google.com/js/platform.js" async defer></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.0rc1/angular-route.min.js"></script>

    <script type="text/javascript" src="js/main.js"></script>

    <link rel="icon" type="image/x-icon" href="img/favicon.ico"/>
</head>

<script src="https://www.gstatic.com/firebasejs/4.4.0/firebase.js"></script>
<script>
    // Initialize Firebase
    var config = {
        apiKey: "AIzaSyA5_zLFEivVC-ETuNAe-1rRfc0Jj6z01Dk",
        authDomain: "modular-decoder-118720.firebaseapp.com",
        databaseURL: "https://modular-decoder-118720.firebaseio.com",
        projectId: "modular-decoder-118720",
        storageBucket: "modular-decoder-118720.appspot.com",
        messagingSenderId: "594909480502"
    };
    firebase.initializeApp(config);
</script>

<body>

<div class="left-nav">
    <div class="header" id="header">
        <div class="header-image">
            <img src="img/header.jpg"/>
            <div class="user-info">
                <img id="profile-picture" src="img/dummy-profile.png"/>
                <h2 id="profile-name">Welcome, user</h2>
            </div>
        </div>

    </div>

    <div class="nav-items" id="nav-items">
        <div class="list_item selected" id="list-item-maps">
            <img src="img/map.png"/>
            <a>GeoMaps</a>
        </div>

        <div class="list_item" id="list-item-friend-manager" onclick="showFriendsManager()">
            <img src="img/people.png" id="image-friends-manager"/>
            <a>Friends Manager</a>
        </div>

        <div class="friend-manager-container" id="friend-manager-container">
          <div class="manager-item" onclick="showFindFriends(true)">
            <a>Find Friends</a>
            <img src="img/search.png"/>
          </div>
          <div class="tab-container">
            <div class="tab selected" id="tab-0" onclick="changeTab(0)">
              <a>CURRENT</a>
            </div>
            <div class="tab" id="tab-1" onclick="changeTab(1)">
              <a>PENDING</a>
            </div>
          </div>
          <div class="tab-view-container">
            <div class="current-tab" id="tab-0-content"></div>
            <div class="pending-tab out-view" id="tab-1-content">
              <div class="request-container" id="incoming-container">
                <h1>INCOMING</h1>
                <a id="no-incoming-text">No incoming friend requests!</a>
              </div>
              <div class="request-container" id="outgoing-container">
                <h1>OUTGOING</h1>
                <a id="no-outgoing-text">No outgoing friend requests!</a>
              </div>
            </div>
          </div>
        </div>

    </div>

    <div class="nav-settings-bar">
        <div class="settings-wrapper">
            <!-- <button id="lock" type="image" onclick=""/> -->
            <button id="settings" type="image" onclick="showSettings(true)"/>
            <button id="lock" type="image" onclick="logout()"/>
        </div>
    </div>

</div>

<div class="map-container">
    <!-- <div id="searchContainer">
        <div class="controls">
            <input id="pac-input" class="input" type="text" placeholder="Search...">
            <div class="searchbox-searchbutton-container">
                <button id="searchbutton" aria-label="Search" class="searchbox-searchbutton">
                    <span aria-hidden="true" class="controls-tooltip tooltip-dark">Search</span>
                </button>
            </div>
            <div class="navigationbutton-container">
                <img src="img/directions.png">
                <span aria-hidden="true" class="controls-tooltip tooltip-dark">Directions</span>
                </img>
            </div>
        </div>

    </div> -->
    <div class="controls-container" id="controls-container">
      <div class="show-share-container" onclick="showRightNav()">
        <img src="img/share-white.png">
      </div>
      <div class="center-map-container" onclick="centerMyLocation()">
        <img src="img/gps-white.png">
      </div>
    </div>
    <div id="map"></div>
</div>

<div class="right-nav" id="right-nav">
  <div class="friendsWrapper" id="friendsWrapper">

  </div>
</div>

<div class="friend-search" id="friend-search-container">
  <div class="friend-search-background" onclick="showFindFriends(false)"></div>
  <div class="friend-search-container">
    <div class="friend-search-wrapper">
      <div class="friend-search-box">
        <input id="name" type="text" name="name" placeholder="Find Friends" oninput="getSearchResults(this.value)" required>
        <img src="img/search.png"/>
      </div>
      <div class="friend-search-results" id="friend-search-results">
        <div class="recentSearchContainer" id="recentSearchContainer"></div>
        <div class="search-results-container" id="search-results-container"></div>
      </div>
    </div>
    <div class="friend-content-wrapper"></div>
  </div>
</div>

<div id="settings-container" class="settings">
    <div class="settings-background" onclick="showSettings(false)"></div>
    <div class="settings-container">
      <div class="nav-bar">
        <button id="close" type="image" onclick="showSettings(false)"/>
      </div>
      <div class="pref-screen">
        <div class="settings-category">
          <div class="heading">
            <h3>Location</h3>
          </div>
          <div class="item-empty">
            <h4>Nearby radius</h4>
          </div>
        </div>

        <div class="settings-category">
          <div class="heading">
            <h3>Account</h3>
          </div>
          <div class="item-empty">
            <h4>Display name</h4>
          </div>
          <div class="item-empty">
            <h4>Profile picture</h4>
          </div>
          <div class="item-empty">
            <h4>Change password</h4>
          </div>
          <div class="item-empty">
            <h4>Delete user</h4>
          </div>
        </div>

        <div class="settings-category">
          <div class="heading">
            <h3>About</h3>
          </div>
          <div class="item-empty disabled">
            <h4>Version 1.0</h4>
          </div>
          <div class="item-empty">
            <h4>Send feedback</h4>
          </div>
          <div class="item-empty">
            <h4>FAQ</h4>
          </div>
        </div>
      </div>
      </div>

      <div class="content-screen">

      </div>
    </div>
</div>

<script>

    var map;

    var currentUid = null;
    var customLogout = false;
    var currentMode = null;
    var currentSelection = null;

    var isShowingManager = false;

    var friendMarker = {};

    document.addEventListener('DOMContentLoaded', function () {
        var mode = getParameterByName('mode');

        var auth = firebase.auth();

        switch (mode) {
            case 'settings':
                showSettings(true);
                break;
            case 'manager':
                showManager();
                isShowingManager = true;
                break;
            case 'search':
                showManager();
                showFindFriends(true);
                isShowingManager = true;
                break;
            default:
        }
    }, false);

    window.addEventListener('popstate', function () {
        var mode = getParameterByName('mode');

        switch (mode) {
          case '':
            showSettings(false);
            showFindFriends(false);
            hideManager();
            break;
          case 'manager':
            if (currentMode != mode) {
              showManager();
              isShowingManager = true;
            }
            break;
          case 'search':
            if (currentMode != mode) {
              showManager();
              showFindFriends(true);
              isShowingManager = true;
            }
            break;
          case 'settings':
            if (currentMode != mode) {
              showSettings(true);
            }
            break;
          default:
            showSettings(false);

        }
    });

    function getParameterByName(name) {
        name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
        var regexS = "[\\?&]" + name + "=([^&#]*)";
        var regex = new RegExp(regexS);
        var results = regex.exec(window.location.href);

        if (results == null)
            return "";
        else
            return decodeURIComponent(results[1].replace(/\+/g, " "));
    }

    firebase.auth().onAuthStateChanged(function (user) {
        if (user && user.uid != currentUid) {
            currentUid = user.uid;
            setup();
        } else {
            currentUid = null;
            console.log("No user signed in!");
            if (!customLogout) {
                window.location.replace('/auth/action?mode=signin');
            } else {
                window.location.replace('/auth/action?signedOut=success')
            }
        }
    });

    function logout() {
        firebase.auth().signOut().then(function () {
            customLogout = true;
        }).catch(function () {
            window.location.replace('/auth/action?signedOut=failed')
        });
    }

    function setup() {
        if (currentUid != null) {
            //UI setup from Firebase

            //Profile picture
            var storage = firebase.storage();
            var gsRef = storage.refFromURL('gs://modular-decoder-118720.appspot.com/profile_pictures');

            gsRef.child('/' + currentUid + '.png').getDownloadURL().then(function (url) {
                var img = document.getElementById('profile-picture');
                img.src = url;
            }).catch(function (error) {

            });

            //Profile name
            var ref = firebase.database().ref('/users/' + currentUid);
            ref.on("value", function (snapshot) {
                var name = (snapshot.val() && snapshot.val().name);
                document.getElementById('profile-name').innerHTML = 'Welcome, ' + name;
            }, function (error) {

            });

            getFriendsList();
            getFriendRequests();

            getSharedLocations();
            getTrackingInfo();
        }
    }

    function getTrackingInfo() {
      var trackingRef = firebase.database().ref('/current_location/' + currentUid + "/tracking");
      trackingRef.on("child_added", function (snapshot) {
        var id = snapshot.key;

        if (snapshot.val().tracking != null) {
          if (snapshot.val().tracking) {
            if (snapshot.val().showOnMap != null) {
              if (snapshot.val().showOnMap) {
                showTrackingFriends(id, false);
                nearbyFriends();
              }
            } else {
              showTrackingFriends(id, false);
              nearbyFriends();
            }
          }
        }

        if (snapshot.val().showOnMap != null) {
          if (!snapshot.val().showOnMap) {
            removeFriendMarker(id);
          }
        }
      });

      trackingRef.on("child_changed", function (snapshot) {
        var id = snapshot.key;

        if (snapshot.val().tracking != null) {
          if (snapshot.val().tracking) {
            showTrackingFriends(id, true);
          }
        }

        if (snapshot.val().showOnMap != null) {
          if (snapshot.val().showOnMap) {
            showTrackingFriends(id, true);
          } else {
            removeFriendMarker(id);
          }
        }
      });

      trackingRef.on("child_removed", function (snapshot) {
        removeFriendMarker(id);
        nearbyFriends();
      });
    }

    function showTrackingFriends(id, isUpdating) {
      var livePositionRef = firebase.database().ref('/current_location/' + id + "/location")
      livePositionRef.once("value").then(function (snapshot) {
        var lat = snapshot.val().lat;
        var long = snapshot.val().longitude;

        if (isUpdating) {
          updateFriendMarker(id, lat, long);
        } else {
          addFriendMarker(id, lat, long);
        }
      });
    }

    function getSharedLocations() {
      var shareRef = firebase.database().ref('/current_location/' + currentUid);
      shareRef.on("child_added", function (snapshot) {
        if (snapshot.key == "tracking") {
          console.log("Tracking");
        } else if (snapshot.key == "location") {
          console.log("Location changed");
        } else {
          addFriendMarker(snapshot.key, snapshot.val().lat, snapshot.val().longitude);
          nearbyFriends();
        }
      });

      shareRef.on("child_changed", function (snapshot) {
        if (snapshot.key == "tracking") {
          console.log("Tracking");
        } else if (snapshot.key == "location") {
          console.log("Location changed");
        } else {
          updateFriendMarker(snapshot.key, snapshot.val().lat, snapshot.val().longitude);
          nearbyFriends();
        }
      });

      shareRef.on("child_removed", function (snapshot) {
        if (snapshot.key == "tracking") {
          console.log("Tracking");
        } else if (snapshot.key == "location") {
          console.log("Location changed");
        } else {
          removeFriendMarker(snapshot.key);
          nearbyFriends();
        }
      });
    }

    function getFriendsList() {
      //Friends list
      var friendRef = firebase.database().ref('/friends/' + currentUid);
      friendRef.on("child_added", function (snapshot) {
        var id = snapshot.key;
        var ref = firebase.database().ref('/users/' + id);
        ref.on("value", function (snapshot) {
            friendName = (snapshot.val() && snapshot.val().name);
            addFriendElement(id, friendName);
            addFriendManagerElement(id, friendName);
        }, function (error) {
            console.log(error.code);
        });

      });

      friendRef.on("child_removed", function (snapshot) {
        removeFriendElement(snapshot.key);
      })
    }

    function getFriendRequests() {
      var friendRequestRef = firebase.database().ref('/pending/' + currentUid);
      friendRequestRef.on("child_added", function (snapshot) {
        var id = snapshot.key;
        var isOutgoing = snapshot.val().outgoing;
        var ref = firebase.database().ref('/users/' + id);
        ref.on("value", function (snapshot) {
          var name = (snapshot.val() && snapshot.val().name);

          addRequestElement(id, name, isOutgoing);
        })
      })
    }

    function getSearchResults(value) {
      removeSearchElements();
      if (value == "") {
        document.getElementById('recentSearchContainer').style.display = '';
      } else {
        document.getElementById('recentSearchContainer').style.display = 'none';
        var searchResultsRef = firebase.database().ref('/users/').orderByChild('caseFoldedName').startAt(value.toLowerCase()).endAt(value.toLowerCase() + '~');
        searchResultsRef.once('value', function (snapshot) {
          snapshot.forEach(function(ds) {
            var id = ds.key;
            var name = ds.val().name;
            addSearchElements(id, name)
          });
        })
      }
    }

    function addSearchElements(id, name) {
      var searchItem = document.createElement("DIV");
      searchItem.className = 'searchItem';
      searchItem.id = id;

      var searchNameContainer = document.createElement("H2");
      var searchName = document.createTextNode(name);
      var searchPicture = document.createElement("IMG");

      getProfileImage(id, searchPicture);

      searchNameContainer.appendChild(searchName);
      searchItem.appendChild(searchPicture);
      searchItem.appendChild(searchNameContainer);

      document.getElementById('search-results-container').insertBefore(searchItem, document.getElementById('search-results-container').firstChild);
    }

    function removeSearchElements() {
      var searchResContainer = document.getElementById('search-results-container');
      while (searchResContainer.lastChild) {
        searchResContainer.removeChild(searchResContainer.lastChild);
      }
    }

    function getRecentSearch() {
      var recentSearchRef = firebase.database().ref('/recent_friends_search/' + currentUid);
      recentSearchRef.on("child_added", function (snapshot) {
        var entry = snapshot.val().entry;
        var isSearch = snapshot.val().search;
        var id = snapshot.val().uid;
        addRecentSearchElement(entry, isSearch, id);
      });
    }

    function addRecentSearchElement(entry, isSearch, id) {
      var recentSearchItem = document.createElement("DIV");
      recentSearchItem.className = 'searchItem';
      recentSearchItem.id = id;

      var recentSearchNameContainer = document.createElement("H2");
      var recentSearchName = document.createTextNode(entry);
      var recentSearchPicture = document.createElement("IMG");

      if (isSearch) {
        recentSearchPicture.src = 'img/search.png';
      } else {
        getProfileImage(id, recentSearchPicture);
      }

      recentSearchNameContainer.appendChild(recentSearchName);
      recentSearchItem.appendChild(recentSearchPicture);
      recentSearchItem.appendChild(recentSearchNameContainer);

      document.getElementById('recentSearchContainer').insertBefore(recentSearchItem, document.getElementById('recentSearchContainer').firstChild);
    }

    function addFriendElement(id, name) {
      var friendContainer = document.createElement("DIV");
      friendContainer.className = 'friendContainer';
      friendContainer.id = id;

      var friendItem = document.createElement("DIV");
      friendItem.className = 'friendItem';

      var friendNameContainer = document.createElement("H2");
      var friendName = document.createTextNode(name);
      var friendPicture = document.createElement("IMG");

      getProfileImage(id, friendPicture);

      friendNameContainer.appendChild(friendName);
      friendItem.appendChild(friendNameContainer);
      friendItem.appendChild(friendPicture);
      friendContainer.appendChild(friendItem);

      document.getElementById('friendsWrapper').appendChild(friendContainer);

      friendContainer.onclick = function() {
        //addParameter("window.location.href", "friendId", id, false);

        if (currentSelection != null && currentSelection != id) {
          document.getElementById(currentSelection + '-options').remove();
          document.getElementById(currentSelection).className = ('friendContainer');
        }
        var optionDiv = document.getElementById(id + '-options');
        if (optionDiv == null) {
          document.getElementById(id).className = ('friendContainer no-hover');
          //Container
          var friendOptionsContainer = document.createElement("DIV");
          friendOptionsContainer.className = 'friendOptionsContainer';
          friendOptionsContainer.id = id + '-options';

          //Options
          //Share option
          var friendOptionsShareContainer = document.createElement("DIV");
          friendOptionsShareContainer.className = 'friendOptionsItem first';
          var friendOptionsShare = document.createElement("H2");
          var friendOptionsShareText = document.createTextNode('Share current location');
          friendOptionsShare.appendChild(friendOptionsShareText);
          friendOptionsShareContainer.appendChild(friendOptionsShare);

          friendOptionsShareContainer.onclick = function(event) {
            event.stopPropagation()
            console.log("Share");
          }

          //Request option
          var friendOptionsFindContainer = document.createElement("DIV");
          friendOptionsFindContainer.className = 'friendOptionsItem';
          var friendOptionsFind = document.createElement("H2");
          var friendOptionsFindText = document.createTextNode('Find location');
          friendOptionsFind.appendChild(friendOptionsFindText);
          friendOptionsFindContainer.appendChild(friendOptionsFind);

          friendOptionsFindContainer.onclick = function(event) {
            event.stopPropagation()
            console.log("Find");
            var marker = friendMarker[id];
            if (marker != null) {
              var latLng = new google.maps.LatLng(marker.position.lat(), marker.position.lng());
              map.setCenter(latLng);
            }
          }

          //Show option
          var friendOptionsShowContainer = document.createElement("DIV");
          friendOptionsShowContainer.className = 'friendOptionsItem last';
          var friendOptionsShow = document.createElement("H2");
          var friendOptionsShowText = document.createTextNode('Show on map');
          friendOptionsShow.appendChild(friendOptionsShowText);
          friendOptionsShowContainer.appendChild(friendOptionsShow);

          friendOptionsShowContainer.onclick = function(event) {
            event.stopPropagation()
          }

          //Append children to parent container
          friendOptionsContainer.appendChild(friendOptionsShareContainer);
          friendOptionsContainer.appendChild(friendOptionsFindContainer);
          friendOptionsContainer.appendChild(friendOptionsShowContainer);

          document.getElementById(id).appendChild(friendOptionsContainer);

          currentSelection = id;
        } else {
          currentSelection = null;
          optionDiv.remove();
          document.getElementById(id).className = ('friendContainer');
        }
      };
    }

    function addFriendManagerElement(id, name) {
      var friendCurrentItem = document.createElement("DIV");
      friendCurrentItem.className = 'friendCurrentItem';
      friendCurrentItem.id = id + '-manager';

      var friendCurrentNameContainer = document.createElement("H2");
      var friendCurrentName = document.createTextNode(name);

      var friendCurrentPicture = document.createElement("IMG");
      friendCurrentPicture.className = 'friendCurrentPicture';
      getProfileImage(id, friendCurrentPicture);

      var friendCurrentMore = document.createElement("IMG");
      friendCurrentMore.className = 'friendCurrentMore';
      friendCurrentMore.src = 'img/more.png';

      friendCurrentNameContainer.appendChild(friendCurrentName);
      friendCurrentItem.appendChild(friendCurrentPicture);
      friendCurrentItem.appendChild(friendCurrentNameContainer);
      friendCurrentItem.appendChild(friendCurrentMore);

      document.getElementById('tab-0-content').appendChild(friendCurrentItem);

      friendCurrentMore.onclick = function() {
        var moreDiv = document.getElementById('more');
        if (moreDiv == null) {
          var more = document.createElement("DIV");
          more.className = 'more';
          more.id = 'more';

          friendCurrentItem.appendChild(more);
        } else {
          moreDiv.remove();
        }
      };
    }

    function addRequestElement(id, name, isOutgoing) {
      var friendRequestItem = document.createElement("DIV");
      friendRequestItem.className = 'friendRequestItem';
      friendRequestItem.id = id + '-manager-request';

      var friendRequestNameContainer = document.createElement("H2");
      var friendRequestName = document.createTextNode(name);

      var friendRequestPicture = document.createElement("IMG");
      friendRequestPicture.className = 'friendRequestPicture';
      getProfileImage(id, friendRequestPicture);

      friendRequestNameContainer.appendChild(friendRequestName);
      friendRequestItem.appendChild(friendRequestPicture);
      friendRequestItem.appendChild(friendRequestNameContainer);

      if (!isOutgoing) {
        document.getElementById('incoming-container').appendChild(friendRequestItem);
        document.getElementById('no-incoming-text').style.display = 'none';
      } else {
        document.getElementById('outgoing-container').appendChild(friendRequestItem);
        document.getElementById('no-outgoing-text').style.display = 'none';
      }
    }

    function removeFriendElement(id) {
      var friendContainer = document.getElementById(id);
      friendContainer.remove();
    }

    function getProfileImage(id, friendPicture) {
      var imageUrl = null;
      //Profile picture
      var storage = firebase.storage();
      var gsRef = storage.refFromURL('gs://modular-decoder-118720.appspot.com/profile_pictures');

      gsRef.child('/' + id + '.png').getDownloadURL().then(function (url) {
          friendPicture.src = url;
      }).catch(function (error) {
        friendPicture.src = 'img/dummy-profile.png'
      });
    }

    function createFriendMarkerImage(id) {
      var canvas, context;

      var width = 64;
      var height = 86;
      var radius = 4;

      var marker = friendMarker[id];

      var markerImg = new Image();
      markerImg.src = 'img/marker.png';

      canvas = document.createElement("canvas");
      canvas.width = width;
      canvas.height = height;

      context = canvas.getContext("2d");

      context.clearRect(0,0,width,height);

      var markerImg = new Image();
      markerImg.setAttribute('crossOrigin', 'anonymous');
      markerImg.src = 'img/marker.png';

      var markerProfileImg = new Image();
      markerProfileImg.setAttribute('crossOrigin', 'anonymous');
      //Profile picture
      var storage = firebase.storage();
      var gsRef = storage.refFromURL('gs://modular-decoder-118720.appspot.com/profile_pictures');

      gsRef.child('/' + id + '.png').getDownloadURL().then(function (url) {
          markerProfileImg.src = url;
      }).catch(function (error) {

      });

      markerProfileImg.onload = function() {
        context.drawImage(markerImg, 0, 0, width, height);
        context.drawImage(scaleImage(20, 20, 40, 40, 20, markerProfileImg), 12, 14);

        marker.setIcon(canvas.toDataURL());
      }
    }

    function scaleImage(x, y, width, height, radius, img){
      var canvas = document.createElement("canvas");
      var ctx = canvas.getContext("2d");

      ctx.save();
      ctx.beginPath();
      ctx.arc(x, y, radius, 0, 2 * Math.PI, false);
      ctx.clip();
      ctx.drawImage(img, 0, 0, width, height);
      ctx.restore();

      return canvas;
    }

    function addFriendMarker(id, lat, long) {
      var latLong = {lat: lat, lng: long};
      var marker = new google.maps.Marker({
        position: latLong,
        map: map
      });
      friendMarker[id] = marker;
      createFriendMarkerImage(id);

      var ref = firebase.database().ref('/users/' + id);
      ref.on("value", function (snapshot) {
        var name = (snapshot.val() && snapshot.val().name);
        marker.setTitle(name);
      })
    }

    function updateFriendMarker(id, lat, long) {
      var latLong = {lat: lat, lng: long};
      var marker = friendMarker[id];
      marker.setPosition(latLong);
    }

    function removeFriendMarker(id) {
      var marker = friendMarker[id];
      if (marker != null) {
        marker.setMap(null);
        delete friendMarker[id];
      }
    }

    var isShowingRightNav = false;

    function showRightNav() {
      if (!isShowingRightNav) {
        //document.getElementById('right-nav').style.width = '320px';
        document.getElementById('right-nav').className = 'right-nav open';
        isShowingRightNav = true;
      } else {
        //document.getElementById('right-nav').style.width = '0';
        document.getElementById('right-nav').className = 'right-nav closed';
        isShowingRightNav = false;
      }
    }

    function showSettings(show) {
      if (show) {
        document.getElementById('settings-container').style.display = 'block';
        history.pushState('settings', 'Settings - GeoShare', 'map?mode=settings');
      } else {
        document.getElementById('settings-container').style.display = 'none';
        window.history.pushState('map', 'Map - GeoShare', 'map');
      }
    }

    function showFriendsManager() {
      if (!isShowingManager) {
        isShowingManager = true;
        showManager();
      } else {
        isShowingManager = false;
        hideManager();
      }
    }

    function showManager() {
      document.getElementById('list-item-maps').style.display = 'none';
      document.getElementById('header').style.display = 'none';
      document.getElementById('nav-items').style.height = 'calc(100% - 56px)';
      document.getElementById('list-item-friend-manager').className = 'list_item selected';
      document.getElementById('friend-manager-container').style.display = 'inline-block';
      document.getElementById('image-friends-manager').src = 'img/back.png';
      history.pushState('settings', 'Settings - GeoShare', 'map?mode=manager');
    }

    function hideManager() {
      document.getElementById('list-item-maps').style.display = '';
      document.getElementById('header').style.display = '';
      document.getElementById('nav-items').style.height = 'calc(100% - 277px - 56px)';
      document.getElementById('list-item-friend-manager').className = 'list_item';
      document.getElementById('friend-manager-container').style.display = 'none';
      document.getElementById('image-friends-manager').src = 'img/people.png';
      window.history.pushState('map', 'Map - GeoShare', 'map');
    }

    function changeTab(tab) {
      switch (tab) {
        case 0:
          document.getElementById('tab-0-content').className = 'current-tab';
          document.getElementById('tab-1-content').className = 'pending-tab out-view';

          document.getElementById('tab-0').className = 'tab selected';
          document.getElementById('tab-1').className = 'tab';
          break;
        case 1:
          document.getElementById('tab-0-content').className = 'current-tab out-view';
          document.getElementById('tab-1-content').className = 'pending-tab';

          document.getElementById('tab-0').className = 'tab';
          document.getElementById('tab-1').className = 'tab selected';
          break;
        default:

      }
    }

    var hasRecent = false;
    function showFindFriends(show) {
      if (show) {
        if (!hasRecent) {
          getRecentSearch();
        }
        hasRecent = true;
        document.getElementById('friend-search-container').style.display = 'block';
        history.pushState('settings', 'Search - GeoShare', 'map?mode=search');
      } else {
        document.getElementById('friend-search-container').style.display = 'none';
        window.history.pushState('map', 'Map - GeoShare', 'map?mode=manager');
      }
    }

    function nearbyRadius(center, radius) {
      var nearbyCircle = new google.maps.Circle({
        strokeWeight: 0,
        fillColor: '#4caf50',
        fillOpacity: 0.25,
        map: map,
        center: center,
        radius: radius
      });
    }

    function nearbyFriends() {
      var count = 0;

      for (var id in friendMarker) {
        var marker = friendMarker[id];
        var latLng = new google.maps.LatLng(marker.position.lat(), marker.position.lng());

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function (position) {
                var currentPos = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);

                if (google.maps.geometry.spherical.computeDistanceBetween(currentPos, latLng) < 200) {
                  count = count + 1;
                }
            });


        } else {
            // Browser doesn't support Geolocation
        }
      }
    }

    function centerMyLocation() {
      if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function (position) {
              var currentPos = {
                  lat: position.coords.latitude,
                  lng: position.coords.longitude
              };

              map.setCenter(currentPos);
              map.setZoom(17);
          });
      } else {
          // Browser doesn't support Geolocation
      }
    }

    //Map setup
    function initMap() {
        var styledMapType = new google.maps.StyledMapType(
            [
                {
                    "elementType": "geometry",
                    "stylers": [
                        {
                            "color": "#f5f5f5"
                        }
                    ]
                },
                {
                    "elementType": "labels.icon",
                    "stylers": [
                        {
                            "visibility": "off"
                        }
                    ]
                },
                {
                    "elementType": "labels.text.fill",
                    "stylers": [
                        {
                            "color": "#616161"
                        }
                    ]
                },
                {
                    "elementType": "labels.text.stroke",
                    "stylers": [
                        {
                            "color": "#f5f5f5"
                        }
                    ]
                },
                {
                    "featureType": "administrative.land_parcel",
                    "elementType": "labels.text.fill",
                    "stylers": [
                        {
                            "color": "#bdbdbd"
                        }
                    ]
                },
                {
                    "featureType": "poi",
                    "elementType": "geometry",
                    "stylers": [
                        {
                            "color": "#eeeeee"
                        }
                    ]
                },
                {
                    "featureType": "poi",
                    "elementType": "labels.text.fill",
                    "stylers": [
                        {
                            "color": "#757575"
                        }
                    ]
                },
                {
                    "featureType": "poi.park",
                    "elementType": "geometry",
                    "stylers": [
                        {
                            "color": "#e5e5e5"
                        }
                    ]
                },
                {
                    "featureType": "poi.park",
                    "elementType": "labels.text.fill",
                    "stylers": [
                        {
                            "color": "#9e9e9e"
                        }
                    ]
                },
                {
                    "featureType": "road",
                    "elementType": "geometry",
                    "stylers": [
                        {
                            "color": "#ffffff"
                        }
                    ]
                },
                {
                    "featureType": "road.arterial",
                    "elementType": "labels.text.fill",
                    "stylers": [
                        {
                            "color": "#757575"
                        }
                    ]
                },
                {
                    "featureType": "road.highway",
                    "elementType": "geometry",
                    "stylers": [
                        {
                            "color": "#dadada"
                        }
                    ]
                },
                {
                    "featureType": "road.highway",
                    "elementType": "labels.text.fill",
                    "stylers": [
                        {
                            "color": "#616161"
                        }
                    ]
                },
                {
                    "featureType": "road.local",
                    "elementType": "labels.text.fill",
                    "stylers": [
                        {
                            "color": "#9e9e9e"
                        }
                    ]
                },
                {
                    "featureType": "transit.line",
                    "elementType": "geometry",
                    "stylers": [
                        {
                            "color": "#e5e5e5"
                        }
                    ]
                },
                {
                    "featureType": "transit.station",
                    "elementType": "geometry",
                    "stylers": [
                        {
                            "color": "#eeeeee"
                        }
                    ]
                },
                {
                    "featureType": "water",
                    "elementType": "geometry",
                    "stylers": [
                        {
                            "color": "#c9c9c9"
                        }
                    ]
                },
                {
                    "featureType": "water",
                    "elementType": "labels.text.fill",
                    "stylers": [
                        {
                            "color": "#9e9e9e"
                        }
                    ]
                }
            ],
            {
                name: 'Styled Map'
            }
        );

        map = new google.maps.Map(document.getElementById('map'), {
            zoom: 6,
            disableDefaultUI: true,
            zoomControl: true,
            zoomControlOptions: {position: google.maps.ControlPosition.LEFT_BOTTOM}
        });

        map.mapTypes.set('styled_map', styledMapType);
        map.setMapTypeId('styled_map');

        //var input = document.getElementById('pac-input');
        //var searchContainer = document.getElementById('searchContainer');
        //var searchBox = new google.maps.places.SearchBox(input);
        //map.controls[google.maps.ControlPosition.TOP_LEFT].push(searchContainer);

        map.setOptions({draggableCursor: 'default'});

        // google.maps.event.addListener(map, 'zoom_changed', function () {
        //     if (map.getZoom() < 3) {
        //         map.setZoom(3);
        //     }
        // });

        // map.addListener('bounds_changed', function () {
        //     searchBox.setBounds(map.getBounds());
        // });

        var gpsLocation = null;

        // Try HTML5 geolocation.
        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    var currentPos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };

                    gpsLocation = new google.maps.Marker({
                        position: currentPos,
                        map: map,
                        icon: '../img/gps.png',
                        title: "Location"
                        //anchor: new google.maps.Point(14, 14)
                    });

                    nearbyRadius(currentPos, 200);
                    nearbyFriends();

                    map.setCenter(currentPos);
                    map.setZoom(17);
                });
            } else {
                // Browser doesn't support Geolocation
            }
        }

        getCurrentLocation();

        // searchBox.addListener('places_changed', function () {
        //     var places = searchBox.getPlaces();
        //
        //     if (places.length == 0) {
        //         return;
        //     }
        //
        //     // Clear out the old markers.
        //     markers.forEach(function (marker) {
        //         marker.setMap(null);
        //     });
        //     markers = [];
        //
        //     // For each place, get the icon, name and location.
        //     var bounds = new google.maps.LatLngBounds();
        //     places.forEach(function (place) {
        //         var icon = {
        //             url: place.icon,
        //             size: new google.maps.Size(71, 71),
        //             origin: new google.maps.Point(0, 0),
        //             anchor: new google.maps.Point(17, 34),
        //             scaledSize: new google.maps.Size(25, 25)
        //         };
        //
        //         // Create a marker for each place.
        //         markers.push(new google.maps.Marker({
        //             map: map,
        //             icon: icon,
        //             title: place.name,
        //             position: place.geometry.location
        //         }));
        //
        //         if (place.geometry.viewport) {
        //             // Only geocodes have viewport.
        //             bounds.union(place.geometry.viewport);
        //         } else {
        //             bounds.extend(place.geometry.location);
        //         }
        //     });
        //     map.fitBounds(bounds);
        // });
    }

</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAiUunq8k3vZd9iQenenLA9WwyTWA82Bc4&&libraries=geometry&callback=initMap" async defer></script>

</body>

</html>
