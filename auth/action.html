<!DOCTYPE html>
<head>
    <meta charset="utf-8">
    <title>Login - GeoShare</title>

    <link rel="stylesheet" type="text/css" href="../theme.css"/>
    <link rel="stylesheet" type="text/css" href="login.css"/>

    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet"/>

    <script src="https://apis.google.com/js/platform.js" async defer></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular.min.js"></script>

    <!--<script type="text/javascript" src="action.js"></script>-->

    <script src='https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js'></script>

    <script src="https://www.gstatic.com/firebasejs/4.5.0/firebase.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.5.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.5.0/firebase-auth.js"></script>

    <link rel="icon" type="image/x-icon" href="../img/favicon.ico"/>
</head>



<script>
    // Initialize Firebase
    var config = {
        apiKey: "AIzaSyA5_zLFEivVC-ETuNAe-1rRfc0Jj6z01Dk",
        authDomain: "modular-decoder-118720.firebaseapp.com",
        databaseURL: "https://modular-decoder-118720.firebaseio.com",
        projectId: "modular-decoder-118720",
        storageBucket: "modular-decoder-118720.appspot.com",
        messagingSenderId: "594909480502"
    };
    firebase.initializeApp(config);

    /*
    function signIn(form) {
      var email = form.email.value;
      var password = form.password.value;
      firebase.auth().signInWithEmailAndPassword(email, password).catch(function(error) {
        console.log(error.message);
      });
    }

    firebase.auth().onAuthStateChanged(function(user) {
      if (user) {
        window.location.replace('../../')
      }
    });
    //*/

    function submit() {
        $.ajax({
            url: '',
            type: 'POST',
            data: new FormData($('#loginForm')[0]),
            processData: false,
            contentType: false
        }).done(function () {
            console.log("Done");
        }).fail(function () {
            console.log("Failed");
        })
    }

    document.addEventListener('DOMContentLoaded', function () {
        var mode = getParameterByName('mode');
        var signOut = getParameterByName('signedOut');

        var auth = firebase.auth();

        switch (mode) {
            case 'resetPassword':
                handleResetPassword(auth, getParameterByName('oobCode'));
                break;
            case 'recoverEmail':
                handleRecoverEmail();
                break;
            /*case 'LOGIN':
                handleSignIn(getParameterByName('email'), getParameterByName('password'));
                break;*/
            case 'signin':
                showSignin();
                break;
            case 'signup':
                showSignup();
                break;
            default:
        }

        switch (signOut) {
            case 'success':
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('new-account').style.display = 'none';
                document.getElementById('forgot-password').style.display = 'none';
                break;
            case 'failed':
                window.location.replace('../');
                break;
            default:

        }

        firebase.auth().onAuthStateChanged(function (user) {
            if (user) {
                window.location.replace('../')
            }
        });
    }, false);

    function showSignin() {
        document.getElementById('loginForm').style.display = 'block';
        document.getElementById('new-account').style.display = 'block';
        document.getElementById('forgot-password').style.display = 'block';
    }

    function showSignup() {
        document.getElementById('signupForm').style.display = 'block';
    }

    function handleSignIn(email, password) {
        console.log(email + ' ' + password);
        firebase.auth().signInWithEmailAndPassword(email, password).catch(function (error) {
            console.log(error.message);
        });
    }

    function getParameterByName(name) {
        name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
        var regexS = "[\\?&]" + name + "=([^&#]*)";
        var regex = new RegExp(regexS);
        var results = regex.exec(window.location.href);

        if (results == null)
            return "";
        else
            return decodeURIComponent(results[1].replace(/\+/g, " "));
    }

    function handleResetPassword(auth, actionCode) {
        var accountEmail;
        // Verify the password reset code is valid.
        if (actionCode == '') {
            document.getElementById('getResetPasswordForm').style.display = 'block';
        } else {
            auth.verifyPasswordResetCode(actionCode).then(function (email) {
                var accountEmail = email;

                // TODO: Show the reset screen with the user's email and ask the user for
                // the new password.
                document.getElementById('resetPasswordForm').style.display = 'block';

                // Save the new password.
                auth.confirmPasswordReset(actionCode, newPassword).then(function (resp) {
                    // Password reset has been confirmed and new password updated.

                    // TODO: Display a link back to the app, or sign-in the user directly
                    // if the page belongs to the same domain as the app:
                    // auth.signInWithEmailAndPassword(accountEmail, newPassword);
                }).catch(function (error) {
                    // Error occurred during confirmation. The code might have expired or the
                    // password is too weak.
                });
            }).catch(function (error) {
                // Invalid or expired action code. Ask user to try to reset the password
                // again.
            });
        }
    }

    function handleRecoverEmail() {

    }
</script>

<body>
<div id="content">
    <main id="wrapper">
        <h1>GeoShare</h1>
        <form class="form" id="loginForm" method="post" autocomplete="on">
            <div id="email">
                <div class="field">
                    <input id="email" type="email" name="email" placeholder="Email" required>
                </div>
            </div>
            <div id="password">
                <div class="field">
                    <input id="password" type="password" name="password" placeholder="Password" required>
                </div>
            </div>
            <div id="login">
                <div class="button login">
                    <input type="button" name="mode" value="LOGIN" onclick="handleSignIn(this.form.email.value.toString(), this.form.password.value.toString())">
                </div>
            </div>
        </form>

        <form class="form" id="signupForm" method="" action="#" autocomplete="on">
            <div id="name">
                <div class="field">
                    <input id="name" type="text" name="name" placeholder="Full Name" required>
                </div>
            </div>
            <div id="email">
                <div class="field">
                    <input id="email" type="email" name="email" placeholder="Email" required>
                </div>
            </div>
            <div id="password">
                <div class="field">
                    <input id="password" type="password" name="password" placeholder="Password" required>
                </div>
            </div>
            <div id="login">
                <div class="button login">
                    <input type="submit" name="mode" value="CREATE NEW ACCOUNT" class="g-recaptcha"
                           data-sitekey="6Lf0cCkUAAAAAGfWmcyfOL3A0r7Ty7OA7FWkBI6u" data-callback="">
                </div>
            </div>
        </form>

        <form class="form" id="getResetPasswordForm" method="" action="#" autocomplete="on">
            <div id="email">
                <div class="field">
                    <input id="email" type="email" name="email" placeholder="Email" required>
                </div>
            </div>
            <div id="login">
                <div class="button login">
                    <input type="submit" name="mode" value="DONE">
                </div>
            </div>
        </form>

        <form class="form" id="resetPasswordForm" method="" action="#" autocomplete="on">
            <div id="email">
                <div class="field">
                    <input id="email" type="email" name="email" disabled>
                </div>
            </div>
            <div id="password">
                <div class="field">
                    <input id="password" type="password" name="password" placeholder="New Password" required>
                </div>
            </div>
            <div id="login">
                <div class="button login">
                    <input type="submit" name="mode" value="RESET PASSWORD">
                </div>
            </div>
        </form>

        <div class="new-account-container" id="new-account">
            <div class="button new-account">
                <a href="?mode=signup">
                    <button onclick="">CREATE NEW ACCOUNT</button>
                </a>
            </div>
        </div>
        <div class="forgot-password-container" id="forgot-password">
            <div class="button forgot-password">
                <a href="?mode=resetPassword">
                    <button onclick="">FORGOT PASSWORD?</button>
                </a>
            </div>
        </div>
    </main>
</div>

</body>

</html>
